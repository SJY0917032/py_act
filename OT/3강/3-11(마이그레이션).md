# 3-11

## Migrations

`모델`의 변경내역을 `데이터베이스 스키마`로 반영시키는 효율적인 방법을 제공하는 명령  

- 마이그레이션 파일생성
  - `python manage.py makemigrations <앱이름>`
- 지정 데이터베이스에 마이그레이션 적용
  - `python manage.py migrate <앱이름>`
- 마이그레이션 적용 현황 출력
  - `python manage.py showmigrations <앱이름>`
- 지정 마이그레이션 SQL 내역 출력
  - `python manage.py sqlmigrate <앱이름> <마이그레이션-이름>`

## Migration 파일

`DB`에 어떤 변화를 가하는 **`Operation`** 들을 나열

- 테이블 생성/삭제, 필드 추가/삭제 등
- 커스텀 파이썬/SQL Operation
  - 데이터 마이그레이션 등.

`모델로부터 자동 생성 -> makemigrations`

- 모델 참조 없이 빈 마이그레이션 파일을 만들어서 직접 채워넣기도 한다.

**`주의!! 같은 Migration 파일이라 할지라도 DB 종류에 따라 다른 SQL이 생성된다. `**  

- 모든 DB 엔진들이 같은 기능을 제공하진 않는다.
- `예)` : SQLite DB에서는 기존 테이블에 컬럼 추가가 지원되지 않는다.

## 마이그레이션 파일 생성 및 적용

**필히, 생성된 마이그레이션 파일 내역을 확인한다.**  
**그리고 sqlmigrate명령으로 SQL을 확인한다.**  
위 두개로 의도에 맞게 생성이 됬는지? 확인한다.

```Python
'''
모델 변경내역 (app/models.py)
    ↓
makemigrations명령(마이그레이션파일)
    ↓
migrate명령(DB서버)
'''
```

## 언제 makemigrations를 하는가?

`모델 필드 관련된 어떠한 변경이라도 발생시에는 마이그레이션 파일을 만든다.`  

- 실제 DB Scheme에 가해지는 변화가 없더라도 수행한다.

**`마이그레이션 파일은 모델의 변경 내역을 누적하는 역할`**  

- 적용된 마이그레이션 파일은 **절대** 삭제하면 안된다.
- 마이그레이션 파일이 너무 많아진다면 `squashmigrations` 명령으로 다수의 마이그레이션 파일을 통합할 수 있다.  

## 마이그레이션 (정방향/역방향)

`python manage.py migrate <앱이름>`

- 미적용 마이그레이션파일부터 최근마이그레이션파일까지 정방향으로 순차적으로 실행

`python manage.py migrate <앱이름> <마이그레이션이름>`

- 지정된 마이그레이션이름이 현재 적용된 마이그레이션보다
  - 이후라면, 정방항으로순차적으로 지정 마이그레이션까지 foward한다.
  - 이전이라면, 역방향으로 순차적으로 지정 마이그레이션까지 backward한다

 ## id필드는 자동으로 생성된다

 `모든 DB 테이블에는 Row의 식별 기준인 PK가 필요`
  
  - 장고에서는 기본키로써 id(AutoField)필드를 디폴트 생성
  - 다른 필드를 기본키로 지정하고 싶다면 primary_key = True옵션 적용

## 새로운 필드가 필수 필드라면?

`필수 필드 여부 ` : blank/null 옵션이 모두 False일때 (디폴트)

- makemigrations 명령을 수행할 때, 기존 Record들에 어떤 값을 채워 넣을지 묻습니다.
  - 선택 1 : 지금 그 값을 입력한다.
  - 선택 2 : 명령 수행을 중단.

## 협업 Tip

`절대 하지 말아야할 일`

- 팀원 각자가 마이그레이션 파일을 생성 -> 충돌이 발생

`추천 ) 마이그레이션 파일 생성은 1명이 전담해서 생성`

- 생성한 마이그레이션 파일을 버전관리에 넣고, 다른 팀원들은 이를 받아서 `migrate`만 수행한다!

## Tip

`개발 시에 '서버에 아직 반영하지 않은' 마이그레이션을 다수 생성했다면?`

- 이를 그대로 서버에 반영 (migrate) 하지말고.
- **하나의 마이그레이션으로 합쳐서** 적용하는것을 권장.
  - 방법1 ) 서버로의 미적용 마이그레이션을 전부 롤백하고 -> 롤백된 마이그레이션을 전부 제거하고 -> 새로 마이그레이션 파일을 만든다.
  - 방법2 ) 미적용 마이그레이션들을 하나로 합치기 -> `squashmigrations`명령